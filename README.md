# Система аукциона робуксов

Backend-реализация системы аукциона, аналогичной Telegram Gift Auctions.

## Описание механики

### Основные правила

- **Раунды**: Аукцион состоит из раундов, которые запускаются каждые 60 минут
- **Победители**: В каждом раунде побеждают топ-100 пользователей по сумме ставки (на момент окончания раунда)
- **Приз**: Каждый победитель получает 1000 робуксов
- **Ставки**:
  - Деньги списываются сразу при размещении ставки
  - Один пользователь = одна ставка в раунде (при повышении старая заменяется полностью)
  - Можно делать ставку в любой момент во время раунда
- **Перенос**: Если пользователь не попал в топ-100, его ставка автоматически переносится в следующий раунд (без дополнительного списания)
- **Возврат средств**: Возврат денег происходит только после окончания всего аукциона, если пользователь не выиграл ни в одном раунде

### Архитектурные решения и допущения

1. **Один активный аукцион**: В системе может быть только один активный аукцион одновременно
2. **Раунды по расписанию**: Новый раунд запускается каждые 60 минут (интервал между стартами)
3. **Фиксация победителей**: Победители определяются по снимку топ-100 в момент окончания раунда
4. **Атомарность операций**: Операции выполняются последовательно с проверками баланса до списания. Уникальные индексы MongoDB предотвращают дубликаты ставок.
5. **Конкурентность**: 
   - Уникальный составной индекс (userId + roundId) предотвращает одновременные ставки одного пользователя в одном раунде
   - Проверка баланса выполняется до списания средств
   - Используется оптимистичная блокировка через поле version в модели Bet
   - В production с replica set можно включить MongoDB транзакции для полной атомарности

**Примечание о транзакциях**: Для локальной разработки используется standalone MongoDB без replica set, поэтому транзакции отключены. В production рекомендуется настроить replica set и включить транзакции для критичных операций (BET).

### Пограничные случаи

- **Ставка в последнюю секунду раунда**: Обрабатывается корректно, проверяется статус раунда и время до списания
- **Одновременные ставки от одного пользователя**: Предотвращаются уникальным индексом (userId + roundId)
- **Проверка баланса**: Выполняется до списания средств, предотвращая отрицательный баланс
- **Перенос ставки в новый раунд**: Выполняется последовательно с проверками и атомарными операциями БД
- **Недостаточный баланс**: Валидация выполняется перед любой операцией списания

## Технический стек

- **Backend**: Node.js, TypeScript, Express, MongoDB
- **Frontend**: React, Vite, TypeScript
- **Инфраструктура**: Docker, Docker Compose

## Запуск проекта

### Требования

- Docker и Docker Compose
- Node.js 18+ (для локальной разработки)

### Быстрый старт с Docker

```bash
# Клонировать репозиторий
git clone https://github.com/fornamess/tgsendauction.git
cd tgsendauction

# Запустить все сервисы
docker-compose up -d

# Backend будет доступен на http://localhost:3000
# Frontend будет доступен на http://localhost:5173
# MongoDB будет доступна на localhost:27017
```

### Локальная разработка

#### Backend

```bash
cd backend
npm install

# Создать файл .env (опционально)
# NODE_ENV=development
# PORT=3000
# MONGODB_URI=mongodb://localhost:27017/auction_db

npm run dev
```

Backend будет доступен на `http://localhost:3000`

#### Frontend

```bash
cd frontend
npm install
npm run dev
```

Frontend будет доступен на `http://localhost:5173`

#### MongoDB (если не используете Docker)

Убедитесь, что MongoDB запущена на `localhost:27017` или укажите другой URI в `.env` файле backend.

## API Документация

### Endpoints

#### Аукцион
- `GET /api/auction/current` - Получить текущий активный аукцион
  Возвращает активный аукцион или 404, если нет активного

- `POST /api/auction` - Создать новый аукцион
  Заголовки: `X-User-Id: admin`
  ```json
  {
    "name": "Аукцион робуксов #1",
    "prizeRobux": 1000
  }
  ```

- `POST /api/auction/:auctionId/start` - Запустить аукцион
  Заголовки: `X-User-Id: admin`

- `POST /api/auction/:auctionId/end` - Завершить аукцион и обработать возвраты
  Заголовки: `X-User-Id: admin`

#### Раунды
- `GET /api/round/current` - Получить текущий раунд с топ-100
- `GET /api/round/:id` - Получить информацию о раунде

#### Ставки
- `POST /api/bet` - Разместить или повысить ставку
  ```json
  {
    "roundId": "64f1a2b3c4d5e6f7g8h9i0j1",
    "amount": 10000
  }
  ```
  Заголовки: `X-User-Id: user123`

- `GET /api/bet/my?roundId=...` - Получить свою ставку в раунде
  Заголовки: `X-User-Id: user123`

#### Пользователь
- `GET /api/user/me` - Получить профиль текущего пользователя
  Заголовки: `X-User-Id: user123`
  Возвращает: профиль пользователя, историю транзакций и ставок

- `POST /api/user/deposit` - Пополнить баланс (для тестов)
  Заголовки: `X-User-Id: user123`
  ```json
  {
    "amount": 50000
  }
  ```

- `GET /api/user/:userId` - Получить пользователя по ID

#### Статистика
- `GET /api/stats` - Получить статистику аукциона

## Тестирование

### Запуск ботов для тестирования

Для тестирования системы под нагрузкой используйте ботов из папки `bots/`:

```bash
cd bots
npm install
npm start
```

Боты автоматически делают ставки, включая проверку anti-sniping механизмов (ставки в последнюю секунду раунда).

#### Параметры запуска ботов:

```bash
# Количество ботов (по умолчанию: 10)
NUM_BOTS=20 npm start

# Начальный баланс каждого бота (по умолчанию: 50000)
INITIAL_DEPOSIT=100000 npm start

# URL API (по умолчанию: http://localhost:3000)
API_URL=http://localhost:3000 npm start
```

### Стресс-тест

Для проверки конкурентной обработки запросов:

```bash
cd bots
npm run stress

# Параметры стресс-теста:
NUM_BOTS=50 NUM_CONCURRENT=200 npm run stress
```

Стресс-тест создает множество одновременных запросов на размещение ставок и проверяет корректность обработки.

## Структура проекта

```
tgsendauction/
├── backend/              # Backend API
│   ├── src/
│   │   ├── models/      # MongoDB модели (User, Auction, Round, Bet, Transaction, Winner)
│   │   ├── services/    # Бизнес-логика (AuctionService, RoundService, BetService, etc.)
│   │   ├── controllers/ # HTTP handlers
│   │   ├── routes/      # Express routes
│   │   ├── jobs/        # Cron jobs для автоматического управления раундами
│   │   ├── utils/       # Утилиты (авторизация)
│   │   ├── config/      # Конфигурация (подключение к БД)
│   │   └── app.ts       # Express приложение
│   ├── package.json
│   └── tsconfig.json
├── frontend/             # Frontend приложение
│   ├── src/
│   │   ├── components/  # React компоненты (AuctionDisplay, BetForm, TopBetsList)
│   │   ├── pages/       # Страницы (HomePage, ProfilePage, AdminPage)
│   │   ├── utils/       # Утилиты (API клиент)
│   │   └── App.tsx      # Главный компонент
│   ├── package.json
│   └── vite.config.ts
├── bots/                 # Боты для тестирования
│   ├── src/
│   │   ├── index.ts     # Основной скрипт ботов
│   │   └── stress-test.ts # Стресс-тест
│   └── package.json
├── docker-compose.yml    # Конфигурация Docker
└── README.md
```

## Примеры использования

### 1. Создание и запуск аукциона

```bash
# 1. Создать аукцион (через админ-панель или API)
curl -X POST http://localhost:3000/api/auction \
  -H "Content-Type: application/json" \
  -H "X-User-Id: admin" \
  -d '{"name": "Аукцион робуксов #1", "prizeRobux": 1000}'

# 2. Запустить аукцион
curl -X POST http://localhost:3000/api/auction/{auctionId}/start \
  -H "X-User-Id: admin"
```

### 2. Участие в аукционе

```bash
# 1. Пополнить баланс
curl -X POST http://localhost:3000/api/user/deposit \
  -H "Content-Type: application/json" \
  -H "X-User-Id: user123" \
  -d '{"amount": 50000}'

# 2. Получить текущий раунд
curl http://localhost:3000/api/round/current \
  -H "X-User-Id: user123"

# 3. Разместить ставку
curl -X POST http://localhost:3000/api/bet \
  -H "Content-Type: application/json" \
  -H "X-User-Id: user123" \
  -d '{"roundId": "...", "amount": 10000}'
```

### 3. Просмотр профиля

```bash
curl http://localhost:3000/api/user/me \
  -H "X-User-Id: user123"
```

## Автоматизация

Система автоматически:

1. **Создает новые раунды** - каждые 60 минут (настраивается в `backend/src/services/RoundService.ts`)
2. **Завершает раунды** - в момент окончания времени раунда
3. **Определяет победителей** - топ-100 пользователей по сумме ставки
4. **Начисляет призы** - автоматически начисляет робуксы победителям
5. **Переносит ставки** - проигравшие автоматически переносятся в следующий раунд

Раунды обрабатываются через cron job (проверка каждую минуту), который находится в `backend/src/jobs/scheduler.ts`.

## Примечания о реализации

### Транзакции MongoDB
Для локальной разработки используется standalone MongoDB без replica set. В этой конфигурации MongoDB транзакции не поддерживаются, поэтому:
- Простые операции (DEPOSIT, REFUND, PRIZE) выполняются без транзакций
- Критичные операции (BET) используют уникальные индексы для предотвращения дубликатов
- Для production рекомендуется настроить replica set и включить транзакции

### Защита от конкурентных запросов
- Уникальный индекс `(userId, roundId)` предотвращает множественные ставки одного пользователя
- Проверка баланса выполняется до списания средств
- Оптимистичная блокировка через поле `version` в модели Bet
- Последовательное выполнение операций для критичных участков кода
